<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>BaZi Scanner</title>
<style>
  body { font-family: system-ui, -apple-system, sans-serif; padding: 20px; line-height: 1.5; color: #333; }
  table { border-collapse: collapse; width: 100%; margin-top: 16px; font-size: 14px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #f8f8f8; }
  .status { color: #666; font-style: italic; }
  .highlight { background-color: #fff9c4; font-weight: bold; }
  h2 { border-bottom: 2px solid #eee; padding-bottom: 8px; margin-top: 32px; }
</style>
</head>
<body>

<h2>About This Tool</h2>
<p>
This tool calculates BaZi (Four Pillars of Destiny) using accurate solar term transitions and traditional logic (Five Tigers/Rats formulas).
</p>

<h2>Current Date & Time</h2>
<div id="nowTime">Loading...</div>

<h2>Current BaZi (4 Pillars)</h2>
<table id="current">
  <thead>
    <tr><th>Pillar</th><th>Value</th><th>Hidden Stems</th></tr>
  </thead>
  <tbody id="currentBody">
    <tr><td colspan="3">Calculating current pillars...</td></tr>
  </tbody>
</table>

<h2>Next 10 Days – Important Hours</h2>
<p id="scanStatus" class="status">Scanning for combinations...</p>
<table id="results">
  <thead>
    <tr>
      <th>Date</th>
      <th>Hour</th>
      <th>Pillars (Y-M-D-H)</th>
      <th>Interaction (交互)</th>
      <th>Element</th>
      <th>Hidden Stems</th>
    </tr>
  </thead>
  <tbody id="resultsBody"></tbody>
</table>

<script src="bazi.js"></script>

<script>
/* =========================
   Configurations from bazi.js
========================= */
// These should match the ones in your bazi.js for consistency
const STEM_COMBOS = { "甲己":"土","己甲":"土","乙庚":"金","庚乙":"金","丙辛":"水","辛丙":"水","丁壬":"木","壬丁":"木","戊癸":"火","癸戊":"火" };
const SAN_HE = { "申子辰":"水","寅午戌":"火","亥卯未":"木","巳酉丑":"金" };
const SAN_HUI = { "寅卯辰":"木","巳午未":"火","申酉戌":"金","亥子丑":"水" };

async function runScanner() {
  const now = new Date();
  document.getElementById("nowTime").innerText = now.toLocaleString();
  
  try {
    // 1. Calculate Current BaZi
    const currentResult = await calculateBazi(now);
    const currentBody = document.getElementById("currentBody");
    const pillarNames = ["Year", "Month", "Day", "Hour"];
    
    currentBody.innerHTML = "";
    currentResult.pillars.forEach((p, i) => {
      const row = `<tr>
        <td><strong>${pillarNames[i]}</strong></td>
        <td>${p}</td>
        <td>${currentResult.hiddenStems[i]}</td>
      </tr>`;
      currentBody.innerHTML += row;
    });

    // 2. Scan Next 10 Days
    const resultsBody = document.getElementById("resultsBody");
    const scanStatus = document.getElementById("scanStatus");
    resultsBody.innerHTML = "";

    for (let d = 0; d < 10; d++) {
      const scanDate = new Date(now);
      scanDate.setDate(now.getDate() + d);

      for (let h = 0; h < 24; h += 2) {
        const iterDate = new Date(scanDate);
        iterDate.setHours(h, 0, 0, 0);
        
        // Skip hours in the past for today
        if (iterDate <= now) continue;

        const res = await calculateBazi(iterDate);
        const [yP, mP, dP, hP] = res.pillars;
        const stemsArr = res.pillars.map(p => p[0]);
        const branchesStr = res.pillars.map(p => p[1]).join("");

        let hitFound = false;
        let interaction = "";
        let element = "";

        // Check Stem Combinations (Adjacent)
        const adjPairs = [[0,1,"Year-Month"], [1,2,"Month-Day"], [2,3,"Day-Hour"]];
        for (const [a, b, lab] of adjPairs) {
          const pair = stemsArr[a] + stemsArr[b];
          if (STEM_COMBOS[pair]) {
            interaction = `Stem Combo (${lab})`;
            element = STEM_COMBOS[pair];
            hitFound = true;
          }
        }

        // Check San He / San Hui
        for (const key in SAN_HE) {
          if ([...key].every(b => branchesStr.includes(b))) {
            interaction = "San He (三合)";
            element = SAN_HE[key];
            hitFound = true;
          }
        }
        for (const key in SAN_HUI) {
          if ([...key].every(b => branchesStr.includes(b))) {
            interaction = "San Hui (三會)";
            element = SAN_HUI[key];
            hitFound = true;
          }
        }

        if (hitFound) {
          const row = `<tr class="highlight">
            <td>${iterDate.toLocaleDateString()}</td>
            <td>${h}:00 - ${h+1}:59</td>
            <td>${res.pillars.join("-")}</td>
            <td>${interaction}</td>
            <td>${element}</td>
            <td>${res.hiddenStems.join(" | ")}</td>
          </tr>`;
          resultsBody.innerHTML += row;
        }
      }
    }
    
    scanStatus.innerText = "Scan complete. Highlighting auspicious/significant hours.";
    if (resultsBody.innerHTML === "") {
      resultsBody.innerHTML = "<tr><td colspan='6'>No major interactions found in the next 10 days.</td></tr>";
    }

  } catch (err) {
    console.error(err);
    document.getElementById("scanStatus").innerText = "Error: " + err.message;
  }
}

// Start the scanner
runScanner();
</script>

<footer style="margin-top:40px; border-top: 1px solid #eee; padding-top: 20px;">
  <a href="privacy.html">Privacy Policy</a>
</footer>
</body>
</html>