<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>BaZi Scanner</title>
<style>
  body { font-family: system-ui, -apple-system, sans-serif; padding: 20px; line-height: 1.5; color: #333; }
  table { border-collapse: collapse; width: 100%; margin-top: 16px; font-size: 14px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #f8f8f8; }
  .status { color: #666; font-style: italic; }
  .highlight { background-color: #fff9c4; font-weight: bold; }
  h2 { border-bottom: 2px solid #eee; padding-bottom: 8px; margin-top: 32px; }
</style>
</head>
<body>

<h2>About This Tool</h2>
<p>
This tool calculates BaZi (Four Pillars of Destiny) using accurate solar term transitions and traditional logic (Five Tigers/Rats formulas).
</p>

<h2>Current Date & Time</h2>
<div id="nowTime">Loading...</div>

<h2>Current BaZi (4 Pillars)</h2>
<table id="current">
  <thead>
    <tr><th>Pillar</th><th>Value</th><th>Hidden Stems</th></tr>
  </thead>
  <tbody id="currentBody">
    <tr><td colspan="3">Calculating current pillars...</td></tr>
  </tbody>
</table>

<h2>Next 10 Days – Important Hours</h2>
<p id="scanStatus" class="status">Scanning for combinations...</p>
<table id="results">
  <thead>
    <tr>
      <th>Date</th>
      <th>Hour</th>
      <th>Pillars (Y-M-D-H)</th>
      <th>Interaction (交互)</th>
      <th>Element</th>
      <th>Hidden Stems</th>
    </tr>
  </thead>
  <tbody id="resultsBody"></tbody>
</table>

<script src="bazi.js"></script>

<script>
/* =========================
   Configurations from bazi.js
========================= */
// These should match the ones in your bazi.js for consistency
const STEM_COMBOS = { "甲己":"土","己甲":"土","乙庚":"金","庚乙":"金","丙辛":"水","辛丙":"水","丁壬":"木","壬丁":"木","戊癸":"火","癸戊":"火" };
const SAN_HE = { "申子辰":"水","寅午戌":"火","亥卯未":"木","巳酉丑":"金" };
const SAN_HUI = { "寅卯辰":"木","巳午未":"火","申酉戌":"金","亥子丑":"水" };

async function runScanner() {
  const now = new Date();
  document.getElementById("nowTime").innerText = now.toLocaleString();
  
  try {
    const currentResult = await calculateBazi(now);
    const currentBody = document.getElementById("currentBody");
    const pillarNames = ["Year", "Month", "Day", "Hour"];
    
    currentBody.innerHTML = "";
    currentResult.pillars.forEach((p, i) => {
      const row = `<tr><td><strong>${pillarNames[i]}</strong></td><td>${p}</td><td>${currentResult.hiddenStems[i]}</td></tr>`;
      currentBody.innerHTML += row;
    });

    const resultsBody = document.getElementById("resultsBody");
    resultsBody.innerHTML = "";

    for (let d = 0; d < 10; d++) {
      const scanDate = new Date(now);
      scanDate.setDate(now.getDate() + d);

      for (let h = -1; h < 23; h += 2) {
        const iterDate = new Date(scanDate);
        iterDate.setHours(h, 0, 0, 0);
        
        if (iterDate <= now) continue;

        const res = await calculateBazi(iterDate);
        const stemsArr = res.pillars.map(p => p[0]);
        const branchesStr = res.pillars.map(p => p[1]).join("");

        // 1. Initialize arrays to collect multiple interactions
        let interactions = [];
        let elements = [];

        // 2. Check Stem Combinations (Adjacent)
        const adjPairs = [[0,1,"Y-M"], [1,2,"M-D"], [2,3,"D-H"]];
        for (const [a, b, lab] of adjPairs) {
          const pair = stemsArr[a] + stemsArr[b];
          if (STEM_COMBOS[pair]) {
            interactions.push(`Stem Combo (${lab})`);
            elements.push(STEM_COMBOS[pair]);
          }
        }

        // 3. Check San He
        for (const key in SAN_HE) {
          if ([...key].every(b => branchesStr.includes(b))) {
            interactions.push("San He (三合)");
            elements.push(SAN_HE[key]);
          }
        }

        // 4. Check San Hui
        for (const key in SAN_HUI) {
          if ([...key].every(b => branchesStr.includes(b))) {
            interactions.push("San Hui (三會)");
            elements.push(SAN_HUI[key]);
          }
        }

        // 5. If any interaction was found, define displayH and add the row
        if (interactions.length > 0) {
          const startH = (h + 24) % 24;
          const endH = (h + 2) % 24;
          const displayH = `${startH.toString().padStart(2, '0')}:00 - ${endH.toString().padStart(2, '0')}:00`;

          const row = `<tr class="highlight">
            <td>${iterDate.toLocaleDateString()}</td>
            <td>${displayH}</td>
            <td>${res.pillars.join("-")}</td>
            <td>${interactions.join("<br>")}</td>
            <td>${elements.join(", ")}</td>
            <td>${res.hiddenStems.join(" | ")}</td>
          </tr>`;
          resultsBody.innerHTML += row;
        }
      }
    }
    document.getElementById("scanStatus").innerText = "Scan complete.";
  } catch (err) {
    console.error(err);
    document.getElementById("scanStatus").innerText = "Error: " + err.message;
  }
}
// Start the scanner
runScanner();
</script>

<footer style="margin-top:40px; border-top: 1px solid #eee; padding-top: 20px;">
  <a href="privacy.html">Privacy Policy</a>
</footer>
</body>
</html>