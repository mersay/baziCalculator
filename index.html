<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>BaZi Scanner</title>
<style>
body { font-family: system-ui; padding: 20px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #f0f0f0; }
</style>
</head>
<body>

<h2>Current BaZi</h2>
<table id="current"></table>

<h2>Next 10 Days – Important Hours</h2>
<table id="results"></table>

<script>
/* =========================
   Reference (FIXED)
========================= */
const REF_DATE = new Date("2026-01-07T18:00:00");
const REF_PILLARS = {
  year: "乙巳",
  month: "己丑",
  day: "辛巳",
  hour: "丁酉"
};

/* =========================
   Constants
========================= */
const stems = ["甲","乙","丙","丁","戊","己","庚","辛","壬","癸"];
const branches = ["子","丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"];

const hiddenStems = {
  子:["癸"], 丑:["己","癸","辛"], 寅:["甲","丙","戊"],
  卯:["乙"], 辰:["戊","乙","癸"], 巳:["丙","戊","庚"],
  午:["丁","己"], 未:["己","丁","乙"],
  申:["庚","壬","戊"], 酉:["辛"],
  戌:["戊","辛","丁"], 亥:["壬","甲"]
};

const stemCombos = {
  "甲己":"土","乙庚":"金","丙辛":"水","丁壬":"木","戊癸":"火"
};

const sanHe = {
  "申子辰":"水","寅午戌":"火","亥卯未":"木","巳酉丑":"金"
};

const sanHui = {
  "寅卯辰":"木","巳午未":"火","申酉戌":"金","亥子丑":"水"
};

/* =========================
   Utilities
========================= */
function pillarAt(offset) {
  const stem = stems[(stems.indexOf("辛") + offset) % 10];
  const branch = branches[(branches.indexOf("巳") + offset) % 12];
  return stem + branch;
}

function hourPillar(dayStem, hourIndex) {
  const stemIndex = (stems.indexOf(dayStem) * 2 + hourIndex) % 10;
  return stems[stemIndex] + branches[hourIndex];
}

/* =========================
   Display Current BaZi
========================= */
const currentTable = document.getElementById("current");
currentTable.innerHTML = `
<tr><th>Pillar</th><th>Value</th><th>Hidden Stems</th></tr>
${Object.entries(REF_PILLARS).map(([k,v]) =>
  `<tr><td>${k}</td><td>${v}</td><td>${hiddenStems[v[1]].join(",")}</td></tr>`
).join("")}
`;

/* =========================
   Scan Next 10 Days
========================= */
const now = new Date();
const resultTable = document.getElementById("results");
resultTable.innerHTML = `
<tr>
<th>Date</th><th>Hour</th><th>Rule</th>
<th>Element</th><th>Pillars</th><th>Hidden Stems</th>
</tr>`;

for (let d=0; d<10; d++) {
  const date = new Date(REF_DATE);
  date.setDate(date.getDate() + d);

  const dayPillar = pillarAt(d);
  const dayStem = dayPillar[0];

  for (let h=0; h<12; h++) {
    const hourStart = new Date(date);
    hourStart.setHours(h*2,0,0,0);

    if (hourStart <= now) continue;

    const hourP = hourPillar(dayStem, h);

    const stemsSeq = [
      REF_PILLARS.year[0],
      REF_PILLARS.month[0],
      dayPillar[0],
      hourP[0]
    ];

    const branchesSeq = [
      REF_PILLARS.year[1],
      REF_PILLARS.month[1],
      dayPillar[1],
      hourP[1]
    ];

    /* 天干五合 (adjacent only) */
    const stemPairs = [
      [0,1,"Year–Month"],
      [1,2,"Month–Day"],
      [2,3,"Day–Hour"]
    ];

    for (const [a,b,label] of stemPairs) {
      const key = stemsSeq[a] + stemsSeq[b];
      if (stemCombos[key]) {
        resultTable.innerHTML += `
<tr>
<td>${date.toISOString().slice(0,10)}</td>
<td>${hourStart.getHours()}:00–${hourStart.getHours()+1}:59</td>
<td>天干五合 (${label})</td>
<td>${stemCombos[key]}</td>
<td>${stemsSeq[a]}${branchesSeq[a]} + ${stemsSeq[b]}${branchesSeq[b]}</td>
<td>${hiddenStems[branchesSeq[a]].join(",")} / ${hiddenStems[branchesSeq[b]].join(",")}</td>
</tr>`;
      }
    }

    /* 三合 / 三會 */
    const bSet = branchesSeq.join("");
    for (const k in sanHe) {
      if ([...k].every(x => bSet.includes(x))) {
        resultTable.innerHTML += `
<tr>
<td>${date.toISOString().slice(0,10)}</td>
<td>${hourStart.getHours()}:00–${hourStart.getHours()+1}:59</td>
<td>三合</td>
<td>${sanHe[k]}</td>
<td>${k}</td>
<td>${k.split("").map(b=>hiddenStems[b].join(",")).join(" | ")}</td>
</tr>`;
      }
    }

    for (const k in sanHui) {
      if ([...k].every(x => bSet.includes(x))) {
        resultTable.innerHTML += `
<tr>
<td>${date.toISOString().slice(0,10)}</td>
<td>${hourStart.getHours()}:00–${hourStart.getHours()+1}:59</td>
<td>三會</td>
<td>${sanHui[k]}</td>
<td>${k}</td>
<td>${k.split("").map(b=>hiddenStems[b].join(",")).join(" | ")}</td>
</tr>`;
      }
    }
  }
}
</script>
</body>
</html>
